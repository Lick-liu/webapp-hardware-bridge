<!doctype html>
<!--suppress JSUnusedGlobalSymbols, HtmlFormInputWithoutLabel, JSUnresolvedReference -->
<html lang="zh-CN" xmlns: xmlns:@vue>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>茶坊村本地打印助手配置</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div @vue:mounted="mounted" v-scope>
    <div class="container">
        <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
            <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none" href="#">
                <span class="fs-4">茶坊村本地打印助手配置</span>
            </a>
            <button @click="saveConfig" class="btn btn-success ms-2">保存配置</button>
            <button @click="restartServer" class="btn btn-warning ms-2">重启服务</button>
        </header>
    </div>
    <div class="container" v-if="config != null">
        <div class="row">
            <div class="mb-2 col-xl-4">
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title mb-3">界面设置 (GUI)</h5>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="gui-notification-enabled">启用系统通知</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="gui-notification-enabled" type="checkbox" v-model="config.gui.notification.enabled"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Web/WebSocket 服务</h5>

                        <div class="form-group row mb-2">
                            <label class="col-sm-4" for="server-bind">绑定 IP</label>
                            <div class="col-sm-8">
                                <input class="form-control form-control-sm" id="server-bind" type="text" v-model="config.server.bind"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-4" for="server-address">外部访问地址</label>
                            <div class="col-sm-8">
                                <input class="form-control form-control-sm" id="server-address" type="text" v-model="config.server.address"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-4" for="server-port">监听端口</label>
                            <div class="col-sm-8">
                                <input class="form-control form-control-sm" id="server-port" max="65535" min="1024" type="number" v-model="config.server.port"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="server-authentication-enabled">启用安全认证</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="server-authentication-enabled" type="checkbox" v-model="config.server.authentication.enabled"/>
                            </div>
                        </div>

                        <div class="card mb-2" v-if="config.server.authentication.enabled">
                            <div class="card-body"><h6 class="card-title mb-3">认证详情</h6>
                                <div class="form-group row mb-2">
                                    <label class="col-sm-4" for="server-authentication-token">访问令牌 (Token)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" id="server-authentication-token" type="text" v-model="config.server.authentication.token"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="server-tls-enabled">启用 TLS (HTTPS/WSS)</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="server-tls-enabled" type="checkbox" v-model="config.server.tls.enabled"/>
                            </div>
                        </div>

                        <div class="card mb-2" v-if="config.server.tls.enabled">
                            <div class="card-body"><h6 class="card-title mb-3">TLS 配置</h6>
                                <div class="form-group row mb-2">
                                    <label class="col-sm-4" for="server-tls-self-signed">使用自签名证书</label>
                                    <div class="col-sm-8">
                                        <input class="form-check-input" id="server-tls-self-signed" type="checkbox" v-model="config.server.tls.selfSigned"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4" for="server-tls-cert">证书路径 (Cert)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" id="server-tls-cert" type="text" v-model="config.server.tls.cert"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4" for="server-tls-key">密钥路径 (Key)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" id="server-tls-key" type="text" v-model="config.server.tls.key"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4" for="server-tls-ca-bundle">CA 证书包</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" id="server-tls-ca-bundle" type="text" v-model="config.server.tls.caBundle"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">下载器设置</h5>

                        <div class="form-group row mb-2">
                            <label class="col-sm-4" for="downloader-path">临时保存路径</label>
                            <div class="col-sm-8">
                                <input class="form-control form-control-sm" id="downloader-path" type="text" v-model="config.downloader.path"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-4" for="downloader-timeout">超时时间 (ms)</label>
                            <div class="col-sm-8">
                                <input class="form-control form-control-sm" id="downloader-timeout" type="number" v-model="config.downloader.timeout"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="downloader-ignore-tls-certificate-error">忽略 TLS 证书错误</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="downloader-ignore-tls-certificate-error" type="checkbox" v-model="config.downloader.ignoreTLSCertificateError"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="mb-2 col-xl-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            打印机设置
                            <button @click="addPrinter" class="btn btn-sm btn-success float-end">+</button>
                        </h5>

                        <div class="clearfix pb-3"></div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="printer-enabled">启用打印功能</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="printer-enabled" type="checkbox" v-model="config.printer.enabled"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="printer-auto-add-unknown-type">自动添加未知类型</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="printer-auto-add-unknown-type" type="checkbox" v-model="config.printer.autoAddUnknownType"/>
                            </div>
                        </div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="printer-fallback-to-default">未匹配时使用默认打印机</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="printer-fallback-to-default" type="checkbox" v-model="config.printer.fallbackToDefault"/>
                            </div>
                        </div>

                        <div class="card mb-2" v-for="(printer, index) in config.printer.mappings">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    打印机 {{ index + 1 }} <span v-if="printer.type">({{ printer.type }})</span>
                                    <button @click="removePrinter(index)" class="btn btn-sm btn-danger float-end">-</button>
                                </h5>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">业务类型 (Type)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="text" v-model="printer.type"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">物理打印机</label>
                                    <div class="col-sm-8">
                                        <select class="form-control form-control-sm" type="text" v-model="printer.name">
                                            <option :value="printerSelection.name" v-for="printerSelection in printers">{{ printerSelection.name }}</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-10">自动旋转 (PDF)</label>
                                    <div class="col-sm-2 text-end">
                                        <input class="form-check-input" type="checkbox" v-model="printer.autoRotate"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-10">重置可打印区域</label>
                                    <div class="col-sm-2 text-end">
                                        <input class="form-check-input" type="checkbox" v-model="printer.resetImageableArea"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">强制 DPI</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="number" v-model="printer.forceDPI"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-2 col-xl-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            串口设置
                            <button @click="addSerial" class="btn btn-sm btn-success float-end">+</button>
                        </h5>

                        <div class="clearfix pb-3"></div>

                        <div class="form-group row mb-2">
                            <label class="col-sm-10" for="serial-enabled">启用串口功能</label>
                            <div class="col-sm-2 text-end">
                                <input class="form-check-input" id="serial-enabled" type="checkbox" v-model="config.serial.enabled"/>
                            </div>
                        </div>

                        <div class="card mb-2" v-for="(serial, index) in config.serial.mappings">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    串口 {{ index + 1 }} <span v-if="serial.type">({{ serial.type }})</span>
                                    <button @click="removeSerial(index)" class="btn btn-sm btn-danger float-end">-</button>
                                </h5>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">业务类型 (Type)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="text" v-model="serial.type"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">端口号</label>
                                    <div class="col-sm-8">
                                        <select class="form-control form-control-sm" type="text" v-model="serial.name">
                                            <option :value="serial.name" v-for="serial in serials">{{ serial.name }}</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">波特率 (Baud Rate)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="number" v-model="serial.baudRate"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">数据位 (Data Bits)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="number" v-model="serial.numDataBits"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">停止位 (Stop Bits)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="number" v-model="serial.numStopBits"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">校验位 (Parity)</label>
                                    <div class="col-sm-8">
                                        <input class="form-control form-control-sm" type="number" v-model="serial.parity"/>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-4">读取字符集</label>
                                    <div class="col-sm-8">
                                        <select class="form-control form-control-sm" type="text" v-model="serial.readCharset">
                                            <option :value="charset" v-for="charset in ['UTF-8', 'US-ASCII', 'BINARY']">{{ charset }}</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row mb-2">
                                    <label class="col-sm-10">启用多字节读取</label>
                                    <div class="col-sm-2 text-end">
                                        <input class="form-check-input" type="checkbox" v-model="serial.readMultipleBytes"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/axios.min.js"></script>
<script type="module">import { createApp } from './js/petite-vue.js'

createApp({
    config: null,
    printers: [],
    serials: [],

    loadConfig() {
        return axios.get('/config.json')
            .then(response => this.config = response.data)
    },
    saveConfig() {
        return axios.put('/config.json', this.config)
            .then(response => this.config = response.data)
    },
    addPrinter() {
        this.config.printer.mappings.push({type: 'RECEIPT', name: ''})
    },
    removePrinter(index) {
        this.config.printer.mappings.splice(index, 1)
    },
    addSerial() {
        this.config.serial.mappings.push({type: '', name: ''})
    },
    removeSerial(index) {
        this.config.serial.mappings.splice(index, 1)
    },
    loadPrinters() {
        return axios.get('/system/printers.json')
            .then(response => this.printers = response.data)
    },
    loadSerials() {
        return axios.get('/system/serials.json')
            .then(response => this.serials = response.data)
    },
    restartServer() {
        return axios.post('/system/restart.json', this.config)
    },
    mounted() {
        Promise.all([this.loadPrinters(), this.loadSerials()]).then(() => {
            this.loadConfig()
        })
    }
}).mount()</script>
</body>
</html>